{% extends "garbage_map/wrapper.html" %}

{% block sidebar %}
    {% for cat in categories %} 
        <div>
            <img src = "{{ cat.image.url }}"  width = "100" height = "100" alt = "Мыш" onclick="print_dots({{cat.pk}}, false)">
            <span>{{cat.name}}</span>
        </div>
    {% endfor %}
{% endblock %}

{% block main %}
    <script type="text/javascript">
        var dots = JSON.parse(('{{ dots_json }}').replace(/&quot;/g,'"'));
        var categories = JSON.parse(('{{ categories_json }}').replace(/&quot;/g,'"'));
        var div_list;
        var myMap;
        ymaps.ready(init);
        function init()
        { 
            myMap = new ymaps.Map("map", {
                center: [52.29778, 104.29639],
                zoom: 3,
                controls: ['zoomControl', 'typeSelector', 'routeButtonControl']
            });
            print_dots(-1, true);
        }
        function set_center(x, y)
        {
            myMap.setCenter([x, y], 14, {
                checkZoomRange: true
            });
        }
        function print_dots(category_filter, check)
        {
            myMap.geoObjects.removeAll();
            for (var i = 0; i < dots.length; i++)
            {  
                if (check || dots[i].fields.categories.includes(category_filter))
                { 
                    myMap.geoObjects           
                        .add(new ymaps.Placemark([dots[i].fields.x, dots[i].fields.y], {
                            balloonContentHeader: '<a href = "#">' + dots[i].fields.name + '</a><br>' +
                                '<span class="description">' + dots[i].fields.description + '</span>' + 
                                '<p>Здесь принимают ' + get_category(dots[i].fields.categories) + ' </p>',
                            balloonContentBody: '<img src="' + dots[i].fields.image + '" height="150" width="200"> <br/> ' +
                                '<p>' + dots[i].fields.working_hours + '</p>',
                            hintContent: dots[i].fields.name
                        })); 
                }
            }
            if (!check)
            {
                document.getElementById("list_garbage").style.display = 'none';
                document.getElementById("arrow").style.display = '';
                document.getElementById("title_garbage").innerHTML = get_category([category_filter]);
                div_list = document.createElement('div');
                list.appendChild(div_list);
                for (var i = 0; i < dots.length; i++)
                {
                    if (dots[i].fields.categories.includes(category_filter))
                    {
                        var newLi = document.createElement('button');
                        newLi.innerHTML = dots[i].fields.name;
                        newLi.setAttribute('onClick', "set_center(" + dots[i].fields.x + "," + dots[i].fields.y + ")");
                        div_list.appendChild(newLi);
                    }
                }
                
            }
            else
            {
                document.getElementById("list_garbage").style.display = '';
                document.getElementById("arrow").style.display = 'none';
                document.getElementById("title_garbage").innerHTML = 'Категории мусора';
                list.removeChild(div_list);
            }
        }
        function get_category(garbage_categories)
        {
            var names_of_categories = []
            for (var j = 0; j < categories.length; j++)
            {
                if (garbage_categories.includes(categories[j].pk))
                {
                    names_of_categories.push(categories[j].fields.name);
                }
            }
            return names_of_categories.join(", ");
        }

    </script>

    
    <div id = "map" style = "width: 100%; height: 750px"></div> 




{% endblock %} 
